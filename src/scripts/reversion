#!/bin/sh
# Copyright (c) The Exim Maintainers 2016

set -e
LC_ALL=C
export LC_ALL

# Update Exim's version header file.

# Compatibility gross-ness for non-POSIX systems
if [ -z "$EXIM_REVERSION_ADJUSTED" ]
then
  SHELL=/bin/sh
  EXIM_REVERSION_ADJUSTED=yes
  export SHELL EXIM_REVERSION_ADJUSTED
  # Solaris:
  if [ -x /usr/xpg4/bin/sh ]
  then
    PATH="/usr/xpg4/bin:$PATH"
    SHELL=/usr/xpg4/bin/sh
    export PATH SHELL
  fi
  # Irix:
  _XPG=1 ; export _XPG
  #
  exec "$SHELL" "$0" "$@"
fi

# Read version information that was generated by a previous run of
# this script, or during the release process.

if   [ -f ./version.sh ]
then .    ./version.sh
elif [ -f ../src/version.sh ]
then .    ../src/version.sh
fi

# If this tree is a git working directory, use that to get version information.

if [ -d ../../.git ] || [ "$1" = "release" ]
then
	# Modify the output of git describe into separate parts for
	# the name "exim" and the release and variant versions.
	# Put a dot in the version number and remove a spurious g.
	if [ "$2" ]
	then
	    description=$(git describe "$2")
	else
	    description=$(git describe --dirty=-XX --match 'exim-4*')
	fi
	set $(echo "$description" | sed 's|-| |;s|_|.|;s|[-_]| _|;s|-g|-|')
	# Only update if we need to
	if [ "$2 $3" != "$EXIM_RELEASE_VERSION $EXIM_VARIANT_VERSION" ]
	then
		EXIM_RELEASE_VERSION="$2"
		EXIM_VARIANT_VERSION="$3"
		rm -f version.h
	fi
fi

# If you are maintaining a patched version of Exim, you can either
# create your own version.sh as part of your release process, or you
# can modify EXIM_VARIANT_VERSION at this point in this script.

case "$EXIM_RELEASE_VERSION" in
'')	echo "*** Your copy of Exim lacks any version information."
	exit 1
esac

EXIM_COMPILE_NUMBER=$(expr "${EXIM_COMPILE_NUMBER:-0}" + 1)

echo "$EXIM_COMPILE_NUMBER" >cnumber.h

( echo '# automatically generated file - see ../scripts/reversion'
  echo EXIM_RELEASE_VERSION='"'"$EXIM_RELEASE_VERSION"'"'
  echo EXIM_VARIANT_VERSION='"'"$EXIM_VARIANT_VERSION"'"'
  echo EXIM_COMPILE_NUMBER='"'"$EXIM_COMPILE_NUMBER"'"'
) >version.sh

if [ ! -f version.h ]
then
( echo '/* automatically generated file - see ../scripts/reversion */'
  echo '#define EXIM_RELEASE_VERSION "'"$EXIM_RELEASE_VERSION"'"'
  echo '#define EXIM_VARIANT_VERSION "'"$EXIM_VARIANT_VERSION"'"'
  echo '#define EXIM_VERSION_STR EXIM_RELEASE_VERSION EXIM_VARIANT_VERSION'
) >version.h
fi

echo ">>> version $EXIM_RELEASE_VERSION$EXIM_VARIANT_VERSION #$EXIM_COMPILE_NUMBER"
echo
